(()=>{"use strict";class e{constructor(e){this.container=e,this.fieldId=e.dataset.fieldId,this.maxPhotos=parseInt(e.dataset.maxPhotos)||1,this.isRequired="1"===e.dataset.required,this.apiUrl=e.dataset.apiUrl,this.nonce=e.dataset.nonce,this.photos=[],this.dragIndex=null,this.init()}init(){this.container.innerHTML="",this.grid=document.createElement("div"),this.grid.className="chatty-photo-grid",this.container.appendChild(this.grid),this.renderGrid()}renderGrid(){if(this.grid.innerHTML="",this.photos.forEach((e,t)=>{const a=document.createElement("div");a.className="chatty-photo-thumb"+(e.uploading?" uploading":""),a.draggable=!0,a.dataset.index=t,a.addEventListener("dragstart",e=>{this.dragIndex=t,a.classList.add("chatty-photo-dragging"),e.dataTransfer.effectAllowed="move"}),a.addEventListener("dragend",()=>{a.classList.remove("chatty-photo-dragging"),this.dragIndex=null}),a.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer.dropEffect="move",a.classList.add("drag-over")}),a.addEventListener("dragleave",()=>{a.classList.remove("drag-over")}),a.addEventListener("drop",e=>{if(e.preventDefault(),a.classList.remove("drag-over"),null!==this.dragIndex&&this.dragIndex!==t){const e=this.photos.splice(this.dragIndex,1)[0];this.photos.splice(t,0,e),this.renderGrid()}}),a.addEventListener("touchstart",e=>{this.dragIndex=t,a.classList.add("chatty-photo-dragging")},{passive:!0}),a.addEventListener("touchend",()=>{a.classList.remove("chatty-photo-dragging"),this.dragIndex=null});const s=document.createElement("img");if(s.src=e.url,s.alt=`Photo ${t+1}`,a.appendChild(s),e.uploading){const e=document.createElement("div");e.className="chatty-photo-spinner",e.innerHTML="â³",a.appendChild(e)}if(!e.uploading){const e=document.createElement("button");e.type="button",e.className="chatty-photo-delete",e.innerHTML="âœ•",e.addEventListener("click",e=>{e.stopPropagation(),this.photos.splice(t,1),this.renderGrid()}),a.appendChild(e)}const o=document.createElement("span");o.className="chatty-photo-badge",o.textContent=t+1,a.appendChild(o),this.grid.appendChild(a)}),this.photos.length<this.maxPhotos){const e=document.createElement("div");e.className="chatty-photo-add",e.innerHTML='<span class="chatty-photo-add-icon">ðŸ“·</span><span class="chatty-photo-add-label">+</span>',e.addEventListener("click",()=>this.openCamera()),e.addEventListener("dragover",e=>{e.preventDefault()}),e.addEventListener("drop",e=>{if(e.preventDefault(),null!==this.dragIndex){const e=this.photos.splice(this.dragIndex,1)[0];this.photos.push(e),this.renderGrid()}}),this.grid.appendChild(e)}let e=this.container.querySelector(".chatty-photo-hidden");e||(e=document.createElement("input"),e.type="hidden",e.className="chatty-photo-hidden",e.name=this.fieldId,this.container.appendChild(e)),e.value=this.getUrls().join(","),this.isRequired&&0===this.photos.length?e.setCustomValidity("Please add at least one photo."):e.setCustomValidity("")}openCamera(){const e=document.createElement("input");e.type="file",e.accept="image/*",e.capture="environment",e.style.display="none",document.body.appendChild(e),e.addEventListener("change",()=>{e.files&&e.files[0]&&this.showPreview(e.files[0]),document.body.removeChild(e)}),e.click()}showPreview(e){const t=new FileReader;t.onload=t=>{const a=t.target.result,s=document.createElement("div");s.className="chatty-photo-preview-overlay";const o=document.createElement("img");o.src=a,o.className="chatty-photo-preview-img",s.appendChild(o);const n=document.createElement("div");n.className="chatty-photo-preview-actions";const i=document.createElement("button");i.type="button",i.className="chatty-photo-retake-btn",i.innerHTML="â†» Retake",i.addEventListener("click",()=>{s.remove(),this.openCamera()});const r=document.createElement("button");r.type="button",r.className="chatty-photo-save-btn",r.innerHTML="âœ“ Save",r.addEventListener("click",()=>{s.remove(),this.addPhoto(e,a)}),n.appendChild(i),n.appendChild(r),s.appendChild(n),this.container.appendChild(s)},t.readAsDataURL(e)}async addPhoto(e,t){const a="temp_"+Date.now(),s={id:a,url:t,uploading:!0};this.photos.push(s),this.renderGrid();try{const t=new FormData;t.append("photo",e);const s=await fetch(this.apiUrl,{method:"POST",headers:{"X-WP-Nonce":this.nonce},body:t}),o=await s.json();if(!s.ok)throw new Error(o.message||"Upload failed");const n=this.photos.findIndex(e=>e.id===a);-1!==n&&(this.photos[n]={id:o.id,url:o.url,uploading:!1})}catch(e){console.error("[CHATTY Forms] Photo upload failed:",e);const t=this.photos.findIndex(e=>e.id===a);-1!==t&&this.photos.splice(t,1)}this.renderGrid()}getUrls(){return this.photos.filter(e=>!e.uploading).map(e=>e.url)}isUploading(){return this.photos.some(e=>e.uploading)}}function t(e){const t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]+)"));return t?decodeURIComponent(t[2]):""}function a(e,t){const a=e.querySelector(".chatty-form-download"),s=a?.querySelector(".chatty-form-download-btn");if(a&&s&&t.downloadUrl)s.href=t.downloadUrl,a.style.display="block",a.classList.add("visible");else{const a=e.querySelector(".chatty-form"),s=a.querySelector(".chatty-form-message");s&&(s.innerHTML=t.successMsg,s.classList.add("success")),a.style.display="block"}}document.addEventListener("DOMContentLoaded",()=>{if(!t("chatty_visitor_id")){const e="cf_"+crypto.randomUUID();document.cookie=`chatty_visitor_id=${e};path=/;max-age=31536000;SameSite=Lax`}document.querySelectorAll(".chatty-form-wrapper").forEach(s=>{const o=s.querySelector(".chatty-form"),n=s.querySelector(".chatty-form-gate"),i=s.querySelector(".chatty-form-download"),r=(i?.querySelector(".chatty-form-download-btn"),[]);s.querySelectorAll(".chatty-form-photo-field").forEach(t=>{r.push(new e(t))});const d={formId:s.dataset.formId,delivery:s.dataset.delivery||"message",gate:s.dataset.gate||"none",downloadUrl:s.dataset.download||"",redirectUrl:s.dataset.redirect||"",successMsg:s.dataset.successMsg||"Thank you!",shareText:s.dataset.shareText||"",shareUrl:s.dataset.shareUrl||window.location.href};s.querySelectorAll(".chatty-form-social-btn").forEach(e=>{e.addEventListener("click",()=>{!function(e,t){const a=t.querySelector(".chatty-form-message");a&&(a.innerHTML=`Social login with ${e} requires OAuth credentials. Configure in CHATTY Forms â†’ Settings.`,a.className="chatty-form-message info"),console.log(`[CHATTY Forms] Social login initiated for: ${e}`),console.log("[CHATTY Forms] OAuth flow will be available after API credentials are configured.")}(e.dataset.provider,o)})}),o.addEventListener("submit",async e=>{e.preventDefault();const i=o.querySelector(".chatty-form-message"),c=o.querySelector('button[type="submit"]');i.innerHTML="",i.className="chatty-form-message",c.disabled=!0,c.textContent="Submitting...";const l=new FormData(o),h={};if(l.forEach((e,t)=>{if(t.endsWith("[]")){const a=t.slice(0,-2);h[a]||(h[a]=[]),h[a].push(e)}else h[t]=e}),r.forEach(e=>{const t=e.getUrls();t.length>0&&(h[e.fieldId]=t)}),r.some(e=>e.isUploading()))return i.innerHTML="Photos are still uploading, please wait...",i.classList.add("info"),c.disabled=!1,void(c.textContent="Submit");const p=t("chatty_visitor_id");try{const e=await fetch(chattyFormsFrontend.apiUrl+"/submit",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":chattyFormsFrontend.nonce},body:JSON.stringify({form_id:d.formId,data:h,visitor_id:p||""})}),t=await e.json();if(!e.ok)throw new Error(t.message||"Submission failed");"none"!==d.gate&&"form_only"!==d.gate?(o.style.display="none",n&&(n.style.display="block",function(e,t){e.querySelectorAll(".chatty-share-btn").forEach(s=>{s.addEventListener("click",()=>{const o=s.dataset.platform,n=encodeURIComponent(t.shareText||document.title),i=encodeURIComponent(t.shareUrl||window.location.href);let r="";switch(o){case"facebook":r=`https://www.facebook.com/sharer/sharer.php?u=${i}`;break;case"twitter":r=`https://twitter.com/intent/tweet?text=${n}&url=${i}`;break;case"linkedin":r=`https://www.linkedin.com/shareArticle?mini=true&url=${i}&title=${n}`}r&&(window.open(r,"share","width=600,height=400,scrollbars=yes"),s.classList.add("shared"),s.innerHTML="âœ“ Shared",sessionStorage.setItem(`chatty-shared-${t.formId}`,"1"),setTimeout(()=>{const s=e.querySelector(".chatty-form-gate");s&&(s.style.display="none"),a(e,t)},1500))})})}(s,d))):"redirect"===d.delivery&&d.redirectUrl?(i.innerHTML="Redirecting...",i.classList.add("success"),setTimeout(()=>{window.location.href=d.redirectUrl},500)):"download"===d.delivery&&d.downloadUrl?(o.style.display="none",a(s,d)):(i.innerHTML=d.successMsg,i.classList.add("success"),o.reset())}catch(e){i.innerHTML=e.message,i.classList.add("error")}finally{c.disabled=!1,c.textContent="Submit"}})})})})();