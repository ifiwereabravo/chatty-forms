(()=>{"use strict";class e{constructor(e){this.container=e,this.fieldId=e.dataset.fieldId,this.maxPhotos=parseInt(e.dataset.maxPhotos)||1,this.isRequired="1"===e.dataset.required,this.apiUrl=e.dataset.apiUrl,this.nonce=e.dataset.nonce,this.photos=[],this.dragIndex=null,this.init()}init(){this.container.innerHTML="",this.grid=document.createElement("div"),this.grid.className="chatty-photo-grid",this.container.appendChild(this.grid),this.renderGrid()}renderGrid(){if(this.grid.innerHTML="",this.photos.forEach((e,t)=>{const s=document.createElement("div");s.className="chatty-photo-thumb"+(e.uploading?" uploading":""),s.draggable=!0,s.dataset.index=t,s.addEventListener("dragstart",e=>{this.dragIndex=t,s.classList.add("chatty-photo-dragging"),e.dataTransfer.effectAllowed="move"}),s.addEventListener("dragend",()=>{s.classList.remove("chatty-photo-dragging"),this.dragIndex=null}),s.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer.dropEffect="move",s.classList.add("drag-over")}),s.addEventListener("dragleave",()=>{s.classList.remove("drag-over")}),s.addEventListener("drop",e=>{if(e.preventDefault(),s.classList.remove("drag-over"),null!==this.dragIndex&&this.dragIndex!==t){const e=this.photos.splice(this.dragIndex,1)[0];this.photos.splice(t,0,e),this.renderGrid()}}),s.addEventListener("touchstart",e=>{this.dragIndex=t,s.classList.add("chatty-photo-dragging")},{passive:!0}),s.addEventListener("touchend",()=>{s.classList.remove("chatty-photo-dragging"),this.dragIndex=null});const a=document.createElement("img");if(a.src=e.url,a.alt=`Photo ${t+1}`,s.appendChild(a),e.uploading){const e=document.createElement("div");e.className="chatty-photo-spinner",e.innerHTML="â³",s.appendChild(e)}if(!e.uploading){const e=document.createElement("button");e.type="button",e.className="chatty-photo-delete",e.innerHTML="âœ•",e.addEventListener("click",e=>{e.stopPropagation(),this.photos.splice(t,1),this.renderGrid()}),s.appendChild(e)}const o=document.createElement("span");o.className="chatty-photo-badge",o.textContent=t+1,s.appendChild(o),this.grid.appendChild(s)}),this.photos.length<this.maxPhotos){const e=document.createElement("div");e.className="chatty-photo-add",e.innerHTML='<span class="chatty-photo-add-icon">ðŸ“·</span><span class="chatty-photo-add-label">+</span>',e.addEventListener("click",()=>this.openCamera()),e.addEventListener("dragover",e=>{e.preventDefault()}),e.addEventListener("drop",e=>{if(e.preventDefault(),null!==this.dragIndex){const e=this.photos.splice(this.dragIndex,1)[0];this.photos.push(e),this.renderGrid()}}),this.grid.appendChild(e)}let e=this.container.querySelector(".chatty-photo-hidden");e||(e=document.createElement("input"),e.type="hidden",e.className="chatty-photo-hidden",e.name=this.fieldId,this.container.appendChild(e)),e.value=this.getUrls().join(","),this.isRequired&&0===this.photos.length?e.setCustomValidity("Please add at least one photo."):e.setCustomValidity("")}openCamera(){const e=document.createElement("input");e.type="file",e.accept="image/*",e.capture="environment",e.style.display="none",document.body.appendChild(e),e.addEventListener("change",()=>{e.files&&e.files[0]&&this.showPreview(e.files[0]),document.body.removeChild(e)}),e.click()}showPreview(e){const t=new FileReader;t.onload=t=>{const s=t.target.result,a=document.createElement("div");a.className="chatty-photo-preview-overlay";const o=document.createElement("img");o.src=s,o.className="chatty-photo-preview-img",a.appendChild(o);const n=document.createElement("div");n.className="chatty-photo-preview-actions";const i=document.createElement("button");i.type="button",i.className="chatty-photo-retake-btn",i.innerHTML="â†» Retake",i.addEventListener("click",()=>{a.remove(),this.openCamera()});const r=document.createElement("button");r.type="button",r.className="chatty-photo-save-btn",r.innerHTML="âœ“ Save",r.addEventListener("click",()=>{a.remove(),this.addPhoto(e,s)}),n.appendChild(i),n.appendChild(r),a.appendChild(n),this.container.appendChild(a)},t.readAsDataURL(e)}async addPhoto(e,t){const s="temp_"+Date.now(),a={id:s,url:t,uploading:!0};this.photos.push(a),this.renderGrid();try{const t=new FormData;t.append("photo",e);const a=await fetch(this.apiUrl,{method:"POST",headers:{"X-WP-Nonce":this.nonce},body:t}),o=await a.json();if(!a.ok)throw new Error(o.message||"Upload failed");const n=this.photos.findIndex(e=>e.id===s);-1!==n&&(this.photos[n]={id:o.id,url:o.url,uploading:!1})}catch(e){console.error("[CHATTY Forms] Photo upload failed:",e);const t=this.photos.findIndex(e=>e.id===s);-1!==t&&this.photos.splice(t,1)}this.renderGrid()}getUrls(){return this.photos.filter(e=>!e.uploading).map(e=>e.url)}isUploading(){return this.photos.some(e=>e.uploading)}}function t(e,t){const s=e.querySelector(".chatty-form-download"),a=s?.querySelector(".chatty-form-download-btn");if(s&&a&&t.downloadUrl)a.href=t.downloadUrl,s.style.display="block",s.classList.add("visible");else{const s=e.querySelector(".chatty-form"),a=s.querySelector(".chatty-form-message");a&&(a.innerHTML=t.successMsg,a.classList.add("success")),s.style.display="block"}}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".chatty-form-wrapper").forEach(s=>{const a=s.querySelector(".chatty-form"),o=s.querySelector(".chatty-form-gate"),n=s.querySelector(".chatty-form-download"),i=(n?.querySelector(".chatty-form-download-btn"),[]);s.querySelectorAll(".chatty-form-photo-field").forEach(t=>{i.push(new e(t))});const r={formId:s.dataset.formId,delivery:s.dataset.delivery||"message",gate:s.dataset.gate||"none",downloadUrl:s.dataset.download||"",redirectUrl:s.dataset.redirect||"",successMsg:s.dataset.successMsg||"Thank you!",shareText:s.dataset.shareText||"",shareUrl:s.dataset.shareUrl||window.location.href};s.querySelectorAll(".chatty-form-social-btn").forEach(e=>{e.addEventListener("click",()=>{!function(e,t){const s=t.querySelector(".chatty-form-message");s&&(s.innerHTML=`Social login with ${e} requires OAuth credentials. Configure in CHATTY Forms â†’ Settings.`,s.className="chatty-form-message info"),console.log(`[CHATTY Forms] Social login initiated for: ${e}`),console.log("[CHATTY Forms] OAuth flow will be available after API credentials are configured.")}(e.dataset.provider,a)})}),a.addEventListener("submit",async e=>{e.preventDefault();const n=a.querySelector(".chatty-form-message"),d=a.querySelector('button[type="submit"]');n.innerHTML="",n.className="chatty-form-message",d.disabled=!0,d.textContent="Submitting...";const c=new FormData(a),l={};if(c.forEach((e,t)=>{if(t.endsWith("[]")){const s=t.slice(0,-2);l[s]||(l[s]=[]),l[s].push(e)}else l[t]=e}),i.forEach(e=>{const t=e.getUrls();t.length>0&&(l[e.fieldId]=t)}),i.some(e=>e.isUploading()))return n.innerHTML="Photos are still uploading, please wait...",n.classList.add("info"),d.disabled=!1,void(d.textContent="Submit");const h=function(){const e=document.cookie.match(new RegExp("(^| )chatty_visitor_id=([^;]+)"));return e?decodeURIComponent(e[2]):""}();try{const e=await fetch(chattyFormsFrontend.apiUrl+"/submit",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":chattyFormsFrontend.nonce},body:JSON.stringify({form_id:r.formId,data:l,visitor_id:h||""})}),i=await e.json();if(!e.ok)throw new Error(i.message||"Submission failed");"none"!==r.gate&&"form_only"!==r.gate?(a.style.display="none",o&&(o.style.display="block",function(e,s){e.querySelectorAll(".chatty-share-btn").forEach(a=>{a.addEventListener("click",()=>{const o=a.dataset.platform,n=encodeURIComponent(s.shareText||document.title),i=encodeURIComponent(s.shareUrl||window.location.href);let r="";switch(o){case"facebook":r=`https://www.facebook.com/sharer/sharer.php?u=${i}`;break;case"twitter":r=`https://twitter.com/intent/tweet?text=${n}&url=${i}`;break;case"linkedin":r=`https://www.linkedin.com/shareArticle?mini=true&url=${i}&title=${n}`}r&&(window.open(r,"share","width=600,height=400,scrollbars=yes"),a.classList.add("shared"),a.innerHTML="âœ“ Shared",sessionStorage.setItem(`chatty-shared-${s.formId}`,"1"),setTimeout(()=>{const a=e.querySelector(".chatty-form-gate");a&&(a.style.display="none"),t(e,s)},1500))})})}(s,r))):"redirect"===r.delivery&&r.redirectUrl?(n.innerHTML="Redirecting...",n.classList.add("success"),setTimeout(()=>{window.location.href=r.redirectUrl},500)):"download"===r.delivery&&r.downloadUrl?(a.style.display="none",t(s,r)):(n.innerHTML=r.successMsg,n.classList.add("success"),a.reset())}catch(e){n.innerHTML=e.message,n.classList.add("error")}finally{d.disabled=!1,d.textContent="Submit"}})})})})();